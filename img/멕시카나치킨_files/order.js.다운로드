
var GB_Root = "";
if ($("title").attr("data-version") == "mobile") GB_Root = "/mobile";

function removeOrder(idx,page,pagestr){
	var val = confirm("해당 주문서를 삭제하시겠습니까?");
	if (val){
		var params = "idx="+idx
		$.ajax({type:"POST", url:"/_lib/ajax_removeOrder.asp",data:params,dataType:"html"
		}).done(function(msg){
			if (msg == "OK"){
				alert("주문서가 삭제되었습니다.");
				location.href=GB_Root+"/my_page/order_check.asp?page="+page+"&"+pagestr;
			}else if (msg=="ajax_notStoreLogin" || msg=="ajax_notLogin"){
				alert("회원전용 컨텐츠입니다.\n회원 로그인 후 다시 시도해주세요.");
				location.reload();
			}else{
				alert("주문서 삭제중 오류가 발생했습니다.\n다시 시도해주세요.")
			}
		});
	}
}

function getCartCount(){
	var params = "mode=count";

	$.ajax({type:"POST", url:GB_Root+"/basket/ajax_cartProc.asp",data:params,dataType:"html"
	}).done(function(msg){
		resultCode = msg.split("|");

		if(resultCode[0]=="complete"){
			$("#headCartCnt").html(resultCode[1]);
		}else{
			$("#headCartCnt").html(0);
		}
	});
}

function cartAdd(itemidx,actPage){
	var params = "mode=add&idx="+itemidx;

	$.ajax({type:"POST", url:GB_Root+"/basket/ajax_cartProc.asp",data:params,dataType:"html"
	}).done(function(msg){
		resultCode = msg.split("|");

		if (msg=="ajax_notStoreLogin" || msg=="ajax_notLogin"){
			alert("회원전용 컨텐츠입니다.\n회원 로그인 후 다시 시도해주세요.");
			location.reload();
		}else{
			if(resultCode[0]=="complete"){
				$("#headCartCnt").html(resultCode[1]);

				if (actPage=="cartpage"){
					location.reload();
				}else{
					var val = confirm("선택하신 상품이 장바구니에 담겼습니다.\n확인 하시겠습니까?")
					if (val){
						location.href=GB_Root+"/basket/basket.asp"
					}
				}
			}else{
				alert("DB처리중 오류가 발생했습니다.\n다시 시도해 주세요.");
			}
		}
	});
}

function cartQtyEdit(itemidx,qty){
	var params = "mode=modify&qty="+qty+"&idx="+itemidx;

	$.ajax({type:"POST", url:GB_Root+"/basket/ajax_cartProc.asp",data:params,dataType:"html"
	}).done(function(msg){
		resultCode = msg.split("|");

		if (msg=="ajax_notStoreLogin" || msg=="ajax_notLogin"){
			alert("회원전용 컨텐츠입니다.\n회원 로그인 후 다시 시도해주세요.");
			location.reload();
		}else{
			if (msg=="ajax_notStoreLogin" || msg=="ajax_notLogin"){
				alert("회원전용 컨텐츠입니다.\n회원 로그인 후 다시 시도해주세요.");
				location.reload();
			}else{
				if(resultCode[0]=="complete"){
					location.reload();
				}else{
					alert("DB처리중 오류가 발생했습니다.\n다시 시도해 주세요.");
				}
			}
		}
	});
}

function cartDel(itemidx){
	var val = confirm("해당 상품을 장바구니에서 삭제하시겠습니까?");
	if (val){
		var params = "mode=remove&idx="+itemidx;

		$.ajax({type:"POST", url:GB_Root+"/basket/ajax_cartProc.asp",data:params,dataType:"html"
		}).done(function(msg){
			resultCode = msg.split("|");

			if (msg=="ajax_notStoreLogin" || msg=="ajax_notLogin"){
				alert("회원전용 컨텐츠입니다.\n회원 로그인 후 다시 시도해주세요.");
				location.reload();
			}else{
				if(resultCode[0]=="complete"){
					location.reload();
				}else{
					alert("DB처리중 오류가 발생했습니다.\n다시 시도해 주세요.");
				}
			}
		});
	}
}

function zipcodeck_getStore(zip,addr1,addr2) {
	new daum.Postcode({
		oncomplete: function(data) {
			var fullAddr = '';
			var extraAddr = '';

			if (data.userSelectedType === 'R') {
				fullAddr = data.roadAddress;
			} else {
				fullAddr = data.jibunAddress;
			}
			if(data.userSelectedType === 'R'){
				if(data.bname !== ''){
					extraAddr += data.bname;
				}
				if(data.buildingName !== ''){
					extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
				}
				fullAddr += (extraAddr !== '' ? ' ('+ extraAddr +')' : '');
			}

			//좌표 GET////////////////
			var geocoder = new daum.maps.services.Geocoder();						// 주소-좌표 변환 객체를 생성합니다
			geocoder.addr2coord("'"+fullAddr+"'", function(status, result) {			// 주소로 좌표를 검색합니다
				 if (status === daum.maps.services.Status.OK) {							// 정상적으로 검색이 완료됐으면
					getDeliveryStore(result.addr[0].lat, result.addr[0].lng)
				}else{
					alert("위치 변환에 실패했습니다.\n다시 시도해 주세요.")
				}
			});
			//좌표 GET////////////////

			document.getElementById(zip).value = data.zonecode; //5자리 새우편번호 사용
			document.getElementById(addr1).value = fullAddr;
			document.getElementById(addr2).focus();
		}
	}).open();
}

function getDeliveryStore(ncoord_x, ncoord_y){
	var params = "ncoord_x="+ncoord_x+"&ncoord_y="+ncoord_y;

	if ($("title").attr("data-version") == "mobile"){
		actpage = "/_lib/ajax_getStore_mobile.asp";
	}else{
		actpage = "/_lib/ajax_getStore.asp";
	}

	$.ajax({type:"POST", url:actpage,data:params,dataType:"html"

	}).done(function(msg){
		if(msg!=""){
			$("#deliveryStores").html(msg);
		}else{
			$("#deliveryStores").html("<span style='color: #ac0000'>해당 지역에 주문가능한 매장이 없습니다.</span>");
		}
	});	
}

function addrReg(f){
	if (f.deliveryname.value==""){
		alert("배송지명을 입력해 주세요.");
		f.deliveryname.focus();
		return;
	}
	if (f.d_zip.value == ""){
		alert("주소를 입력해 주세요.");
		f.d_zip.focus();
		return;
	}
	if (f.d_addr2.value == ""){
		alert("상세주소를 입력해 주세요.");
		f.d_addr2.focus();
		return;
	}
	if (f.deliveryStoreidx.value==""){
		alert("주소를 검색하시고 주문매장을 선택해주세요.");
		return;
	}

	var formID = $(f).attr('id');
	var params = $("#"+formID).serialize();

	$.ajax({type:"POST", url:"/_lib/ajax_regDeliveryAddr.asp",data:params,dataType:"html"
	}).done(function(msg){
		if (msg=="ajax_notStoreLogin" || msg=="ajax_notLogin"){
			alert("회원전용 컨텐츠입니다.\n회원 로그인 후 다시 시도해주세요.");
			location.reload();
		}else{
			if(msg=="OK"){
				var target_top = ($("#selectAddrArea").offset().top);
				$('html, body').stop().animate({'scrollTop':target_top+'px'}, 400);
				resetAddrRegArea();
				getMyDeliveryAddr();
			}else{
				alert(msg)
			}
		}
	});	
}

function resetAddrRegArea(){
	document.deliveryFrm.reset();
	$("#deliveryStoreidx").val("");
	$("#deliveryStores").html("<span style='color: #ac0000'>주소를 입력하시면 주문 가능한 매장이 검색됩니다.</span>")
}

function selStore(storeidx,index){
	$("#deliveryStoreidx").val(storeidx)

	$(".address_pick").each(function(i){
		if (i==index){
			$(this).html("선택됨");
			$(this).addClass("active");
		}else{
			$(this).html("선택")
			$(this).removeClass("active");
		}
	});
}

function getMyDeliveryAddr(){
	var params = "";

	if ($("title").attr("data-version") == "mobile"){
		actpage = "/_lib/ajax_getMyDeliveryAddr_mobile.asp";
	}else{
		actpage = "/_lib/ajax_getMyDeliveryAddr.asp";
	}

	$.ajax({type:"POST", url:actpage,data:params,dataType:"html"
	}).done(function(msg){
		if (msg=="ajax_notStoreLogin" || msg=="ajax_notLogin"){
			alert("회원전용 컨텐츠입니다.\n회원 로그인 후 다시 시도해주세요.");
			location.reload();
		}else{
			if(msg!=""){
				$("#deliveryMyList").html(msg);
			}
		}
	});	
}

/*등록된 배달주소 삭제*/
function myAddrDel(idx){
	var val = confirm("해당 배달지를 삭제하시겠습니까?");
	if (val){
		var params = "idx="+idx;

		$.ajax({type:"POST", url:"/_lib/ajax_MyDeliveryAddrRemove.asp",data:params,dataType:"html"
		}).done(function(msg){
			if (msg=="ajax_notStoreLogin" || msg=="ajax_notLogin"){
				alert("회원전용 컨텐츠입니다.\n회원 로그인 후 다시 시도해주세요.");
				location.reload();
			}else{
				if(msg=="OK"){
					alert("배달지가 삭제되었습니다.");
					getMyDeliveryAddr();
				}else{
					alert("다시 시도해주세요.");
				}
			}
		});	
	}
}

/*선택한 배달지 배달주소로 셋팅*/
function selMyAddr(idx){
	var params = "idx="+idx;

	$.ajax({type:"POST", url:"/_lib/ajax_MyDeliveryAddrSet.asp",data:params,dataType:"html"
	}).done(function(msg){
		if (msg=="ajax_notStoreLogin" || msg=="ajax_notLogin"){
			alert("회원전용 컨텐츠입니다.\n회원 로그인 후 다시 시도해주세요.");
			location.reload();
		}else{
			if(msg=="OK"){
				if (pageSort=="order"){
					location.href=GB_Root+"/online/pay.asp";
				}else{
					location.href=GB_Root+"/basket/basket.asp";
				}
			}else{
				alert("다시 시도해주세요.");
			}
		}
	});	
}